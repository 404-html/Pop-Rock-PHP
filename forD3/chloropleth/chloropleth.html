<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Chloropleth project for FCC cert</title>
        <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
        <script src='https://d3js.org/d3.v4.min.js'></script>
    </head>
<body>

<script>

// Width and Height
const w = 800;
const h = 600;

// Map projection
const projection = d3.geoAlbersUsa()
                     .translate([w/2, h/2])
                     .scale([1000]);

// Path Generator
const path = d3.geoPath()
               .projection(projection);

const color = d3.scaleOrdinal(d3.schemeCategory20);

// Create SVG
const svg = d3.select("body")
              .append("svg")
              .attr("width", w)
              .attr("height", h);

d3.json('for_user_education.json', function (edu) {
    color.domain([
        d3.min(edu, function (d) {return d.value;}),
        d3.max(edu, function (d) {return d.value;})
    ]);

    d3.json ('counties.json', function (counties) {
        for (var i=0; i < edu.length; i++) {
            const countyName = edu[i].area_name;
            const stateName = edu[i].state;
            const countyFips = edu[i].fips;
            const bachelors = parseFloat(edu[i].bachelorsOrHigher);

            for (var j=0; j < counties.geometries.length; j++) {
                const countyID = counties.geometries[j].properties.id;
                if (countyID == countyFips) {
                    counties.geometries[j].properties.countyName = countyName;
                    counties.geometries[j].properties.stateName = stateName;
                    counties.geometries[j].properties.bachelors = bachelors;
                    break;
                }
            }
        }

        svg.selectAll('path')
           .data(json.geometries)
           .enter()
           .append('path')
           .style('fill', function(d) {
               const value = d.geometries.bachelors;
               if (value) {
                   return color(value);
               } else {
                   return '#ccc';
               }
           });
    });
});








// Colors map based on winning candidates
function colorStates (usasvg) {
    // resets svg map so it updates when changing sets of candidates
    d3.select('svg').html('');
    
    svg.selectAll("path")
        .edu(usasvg.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("stroke", "#e0e0e0")
        .attr("class", function(d) {
            let value = d.properties.winner;
            switch (value) {
                case 1:
                    return "frank-atwood"; // frank-atwood
                    break; 				
                default:
                    return "nope";
                    break;  
            }
        })
        .on("mouseover", function(d) {
            
            const stateCandi = d3.select("#stateCandidates");

            stateCandi.classed("hidden", false);
                        
            for (var c = 0; c < d.properties.candidates.length; c++) {
                const candiID = d.properties.candidates[c].candidateID;
                const candiName = d.properties.candidates[c].candidateName;
                const popVotes = d.properties.candidates[c].popVotes;
                const candiParty = d.properties.candidates[c].partyAbbr;
      
                stateCandi.append("div").attr("class", "candiRow").text(`${candiName} (${candiParty}), ${popVotes}`);

        }
    })

        .on("mouseout", function(){
            d3.selectAll(".candiRow").remove();
            d3.select("#stateCandidates").classed("hidden", true);
        })
        .append("title")
        .text(function(d){
            return d.properties.name;
        });
       /* */
         
} // end of colorStates 

function makeToolTip (d) {
    
    svg.select("#stateCandidates")
       .text(`${candiName} (${candiParty}) got ${popVotes} votes`);
    console.log(`${candiName} (${candiParty}) got ${popVotes} votes`);
}

function getGeoJSON () {
    d3.json("edu/counties.json", function(json) {
        $.when(attachWinnersToMap(json))
        .then(colorStates(json))
        .then(attachCandidatesToMap(json));
        console.log(json);
    });
}; // end of getGeoJSON

function allThisStuff (myFilter) {
	//console.log("allThisStuff has started and myFilter = " + myFilter);
    fetch("everyone.php").then(function(response){   
        //console.log("RESPONSE at start of allThisStuff = " + response);        
        return response.json();
    }).then(function(response){ 
        filteredCandidates = filterCandidates(response, myFilter);
        wrangleWinners (filteredCandidates);
        getGeoJSON();    
    });
    console.log(states);
} // end of allThisStuff

//let opponentsArray = allSocialists;
// is making everyone the default this easy?
let opponentsArray = everyone;

allThisStuff (opponentsArray);  	

// Updates map via AJAX when radio button selection changes

</script>

<div id="legend">
    <div class="row">
        <div class="candi-legend col" id="alyson-kennedy">
            <div class="candi-box alyson-kennedy"></div>
            <div class="candi-name">Alyson Kennedy</div>
        </div>
        <div class="candi-legend col" id="bradford-lyttle">
            <div class="candi-box bradford-lyttle"></div>
            <div class="candi-name">Bradford Lyttle</div>
        </div>    
    </div> <!-- End of Row -->
	
</div> <!-- End of Legend -->
	
</div> <!-- End of Container -->

</body>
</html>